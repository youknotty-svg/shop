<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fresh Market</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <style>
        :root {
            --bg: #000000;
            --card-bg: #1c1c1e;
            --item-bg: #2c2c2e;
            --text: #ffffff;
            --text-sec: #8e8e93;
            --accent: #0a84ff;
            --border: #38383a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            padding-bottom: 90px;
            -webkit-font-smoothing: antialiased;
        }

        /* HEADER */
        .header {
            position: sticky; top: 0; z-index: 1000;
            background: rgba(28, 28, 30, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 12px 16px;
        }

        .search-wrap { position: relative; width: 100%; }
        .search-input {
            width: 100%; padding: 10px 40px 10px 36px;
            border-radius: 12px; border: none;
            background: #2c2c2e; color: #fff; font-size: 16px;
        }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: 0.5; }
        
        /* CART BUTTON (Floating) */
        .cart-float {
            position: fixed; bottom: 20px; right: 20px;
            width: 56px; height: 56px; border-radius: 28px;
            background: var(--accent);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            z-index: 900; cursor: pointer;
            transition: transform 0.2s;
        }
        .cart-float:active { transform: scale(0.9); }
        .cart-badge {
            position: absolute; top: -5px; right: -5px;
            background: #ff3b30; color: #fff;
            font-size: 12px; font-weight: bold;
            padding: 4px 8px; border-radius: 10px;
            min-width: 20px; text-align: center;
            border: 2px solid var(--bg);
        }

        /* ACCORDION STYLES */
        .container { padding: 10px 0; }

        /* Main Category (Level 1) */
        .cat-row {
            background: var(--card-bg);
            padding: 16px; margin-bottom: 8px;
            display: flex; align-items: center; justify-content: space-between;
            font-size: 18px; font-weight: 700;
            cursor: pointer; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);
        }
        .cat-row:first-child { border-top: none; }
        .cat-icon { font-size: 24px; margin-right: 12px; }
        .arrow { transition: transform 0.3s; color: var(--text-sec); font-size: 14px; }
        .cat-row.expanded .arrow { transform: rotate(180deg); }
        
        /* Subcategory Container (Level 2) */
        .sub-container { display: none; background: var(--bg); }
        .sub-container.visible { display: block; animation: fadeIn 0.3s; }

        /* Subcategory Header */
        .sub-header {
            padding: 12px 16px 12px 24px;
            color: var(--text-sec);
            font-size: 15px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.5px;
            background: #121212;
            border-bottom: 1px solid #222;
        }

        /* Item List */
        .item-list { padding: 0; }
        
        /* Product Item */
        .item-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 16px 12px 24px;
            border-bottom: 1px solid var(--border);
            background: #000;
        }
        .item-info { flex: 1; padding-right: 10px; }
        .item-name { font-size: 16px; font-weight: 500; margin-bottom: 4px; }
        .item-unit { font-size: 13px; color: var(--text-sec); }

        /* Controls */
        .btn-add {
            background: rgba(10, 132, 255, 0.15); color: var(--accent);
            border: none; padding: 6px 14px; border-radius: 14px;
            font-weight: 600; font-size: 14px; cursor: pointer;
        }
        
        .counter-wrap {
            display: flex; align-items: center; gap: 8px;
            background: rgba(10, 132, 255, 0.1);
            padding: 4px 8px; border-radius: 12px;
            cursor: pointer;
        }
        .counter-val { font-size: 16px; font-weight: 700; color: var(--accent); }
        .counter-unit { font-size: 12px; color: var(--text-sec); }

        .btn-comment {
            background: transparent; border: none; font-size: 18px; 
            opacity: 0.3; margin-right: 8px; padding: 4px;
        }
        .btn-comment.active { opacity: 1; }

        /* MODALS */
        .modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); z-index: 2000;
            display: none; align-items: flex-end;
            backdrop-filter: blur(5px);
        }
        .modal.visible { display: flex; }
        .modal-content {
            background: #1c1c1e; width: 100%;
            border-radius: 20px 20px 0 0; padding: 24px;
            max-height: 85vh; overflow-y: auto;
        }
        .modal-title { font-size: 20px; font-weight: 700; margin-bottom: 16px; text-align: center; }

        /* System Input */
        .sys-input-wrap {
            background: #000; border: 1px solid var(--accent);
            border-radius: 12px; padding: 12px;
            display: flex; align-items: center; margin: 20px 0;
        }
        .sys-input {
            width: 100%; background: transparent; border: none;
            color: #fff; font-size: 32px; font-weight: 700;
            text-align: center; outline: none;
        }
        
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .btn-full {
            flex: 1; padding: 14px; border-radius: 12px; border: none;
            font-size: 16px; font-weight: 600; cursor: pointer;
        }
        .btn-grey { background: #3a3a3c; color: #fff; }
        .btn-blue { background: var(--accent); color: #fff; }

        /* Search Results Overlay */
        .search-results {
            display: none; padding-top: 10px;
        }
        .search-results.visible { display: block; }
        .accordions-view.hidden { display: none; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .hidden { display: none !important; }

        /* Order List */
        .order-row {
            display: flex; justify-content: space-between;
            padding: 12px 0; border-bottom: 1px solid #333;
        }
        .order-name { font-weight: 500; font-size: 15px; }
        .order-qty { font-weight: 700; white-space: nowrap; margin-left: 10px; }
    </style>
</head>
<body>

    <div class="header">
        <div class="search-wrap">
            <span class="search-icon">üîç</span>
            <input type="text" class="search-input" id="search" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤...">
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Search Results (Hidden by default) -->
        <div id="searchResults" class="search-results"></div>

        <!-- Accordions View -->
        <div id="accordionView" class="accordions-view"></div>
    </div>

    <!-- Floating Cart -->
    <div class="cart-float hidden" id="cartBtn" onclick="openOrderModal()">
        <span style="font-size: 24px;">üõí</span>
        <div class="cart-badge" id="cartBadge">0</div>
    </div>

    <!-- Input Modal -->
    <div class="modal" id="inputModal">
        <div class="modal-content">
            <div class="modal-title">–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
            <div id="inputName" style="text-align: center; color: var(--text-sec); margin-bottom: 10px;"></div>
            <div class="sys-input-wrap">
                <input type="number" id="sysInput" class="sys-input" inputmode="decimal" placeholder="0">
                <span id="inputUnit" style="font-size: 18px; color: var(--text-sec);"></span>
            </div>
            <div class="modal-btns">
                <button class="btn-full btn-grey" onclick="closeModal('inputModal')">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn-full btn-blue" onclick="saveInput()">–ì–æ—Ç–æ–≤–æ</button>
            </div>
        </div>
    </div>

    <!-- Comment Modal -->
    <div class="modal" id="commentModal">
        <div class="modal-content">
            <div class="modal-title">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ç–æ–≤–∞—Ä—É</div>
            <div id="comName" style="text-align: center; color: var(--text-sec); margin-bottom: 10px;"></div>
            <textarea id="comText" style="width:100%; height:100px; background:#000; border:1px solid #333; color:#fff; border-radius:12px; padding:12px; font-size:16px; resize:none;" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
            <div class="modal-btns">
                <button class="btn-full btn-grey" onclick="closeModal('commentModal')">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn-full btn-blue" onclick="saveComment()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Order Modal -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <div class="modal-title">–í–∞—à –∑–∞–∫–∞–∑</div>
            <div id="orderList" style="margin-bottom: 20px;"></div>
            <textarea id="globalCom" style="width:100%; height:80px; background:#000; border:1px solid #333; color:#fff; border-radius:12px; padding:12px; font-size:16px;" placeholder="–û–±—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É..."></textarea>
            <div class="modal-btns">
                <button class="btn-full btn-grey" onclick="closeModal('orderModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button class="btn-full btn-blue" onclick="sendOrder()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.setHeaderColor('#1c1c1e');
    tg.setBackgroundColor('#000000');

    // === –î–ê–ù–ù–´–ï (–ë–µ–∑ —Ü–µ–Ω, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω—ã) ===
    const DB = {
        "veg": {
            "name": "–û–≤–æ—â–∏", "icon": "ü•¶",
            "subs": {
                "roots": { "name": "–ö–æ—Ä–Ω–µ–ø–ª–æ–¥—ã", "items": [
                    { "id": "galan", "name": "–ì–∞–ª–∞–Ω–≥–∞–ª –∫–æ—Ä–µ–Ω—å", "unit": "–∫–≥" },
                    { "id": "daik", "name": "–î–∞–π–∫–æ–Ω", "unit": "–∫–≥" },
                    { "id": "imbir", "name": "–ò–º–±–∏—Ä—å –∫–æ—Ä–µ–Ω—å", "unit": "–∫–≥" },
                    { "id": "mor_yel", "name": "–ú–æ—Ä–∫–æ–≤—å –∂–µ–ª—Ç–∞—è", "unit": "–∫–≥" },
                    { "id": "mor_myt", "name": "–ú–æ—Ä–∫–æ–≤—å –º—ã—Ç–∞—è", "unit": "–∫–≥" },
                    { "id": "mor_ros", "name": "–ú–æ—Ä–∫–æ–≤—å –†–æ—Å—Å–∏—è", "unit": "–∫–≥" },
                    { "id": "mor_bot", "name": "–ú–æ—Ä–∫–æ–≤—å —Å –±–æ—Ç–≤–æ–π", "unit": "–∫–≥" },
                    { "id": "past", "name": "–ü–∞—Å—Ç–µ—Ä–Ω–∞–∫", "unit": "–∫–≥" },
                    { "id": "rad_red", "name": "–†–µ–¥–∏—Å –∫—Ä–∞—Å–Ω—ã–π", "unit": "–∫–≥" },
                    { "id": "red_arb", "name": "–†–µ–¥—å–∫–∞ –∞—Ä–±—É–∑–Ω–∞—è", "unit": "–∫–≥" },
                    { "id": "rad_bot", "name": "–†–µ–¥–∏—Å –∫—Ä–∞—Å–Ω—ã–π —Å –±–æ—Ç–≤–æ–π", "unit": "–∫–≥" },
                    { "id": "repa", "name": "–†–µ–ø–∞", "unit": "–∫–≥" },
                    { "id": "svek", "name": "–°–≤–µ–∫–ª–∞", "unit": "–∫–≥" },
                    { "id": "seld_kor", "name": "–ö–æ—Ä–µ–Ω—å —Å–µ–ª—å–¥–µ—Ä–µ—è", "unit": "–∫–≥" },
                    { "id": "topin", "name": "–¢–æ–ø–∏–Ω–∞–º–±—É—Ä", "unit": "–∫–≥" },
                    { "id": "hren", "name": "–•—Ä–µ–Ω –∫–æ—Ä–µ–Ω—å", "unit": "–∫–≥" }
                ]},
                "tomatoes": { "name": "–¢–æ–º–∞—Ç—ã", "items": [
                    { "id": "tom_kra", "name": "–¢–æ–º–∞—Ç –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä", "unit": "–∫–≥" },
                    { "id": "tom_yel", "name": "–¢–æ–º–∞—Ç –∂–µ–ª—Ç—ã–π", "unit": "–∫–≥" },
                    { "id": "tom_slv", "name": "–¢–æ–º–∞—Ç –∫—Ä–∞—Å–Ω—ã–π —Å–ª–∏–≤–∫–∞", "unit": "–∫–≥" },
                    { "id": "tom_gri", "name": "–¢–æ–º–∞—Ç –ì—Ä–∏–ª—å", "unit": "–∫–≥" },
                    { "id": "tom_uzb_l", "name": "–¢–æ–º–∞—Ç –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω (–õ—é–∫—Å)", "unit": "–∫–≥" },
                    { "id": "tom_uzb", "name": "–¢–æ–º–∞—Ç –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω", "unit": "–∫–≥" },
                    { "id": "tom_aze", "name": "–¢–æ–º–∞—Ç –ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω", "unit": "–∫–≥" },
                    { "id": "tom_dag", "name": "–¢–æ–º–∞—Ç –î–∞–≥–µ—Å—Ç–∞–Ω", "unit": "–∫–≥" },
                    { "id": "tom_che_y", "name": "–¢–æ–º–∞—Ç —á–µ—Ä—Ä–∏ –∂–µ–ª—Ç—ã–µ", "unit": "–∫–≥" },
                    { "id": "tom_che_r", "name": "–¢–æ–º–∞—Ç —á–µ—Ä—Ä–∏ –∫—Ä–∞—Å–Ω—ã–π", "unit": "–∫–≥" },
                    { "id": "tom_che_k", "name": "–¢–æ–º–∞—Ç —á–µ—Ä—Ä–∏ –∫—É–º–∞—Ç–æ", "unit": "–∫–≥" },
                    { "id": "tom_che_m", "name": "–¢–æ–º–∞—Ç —á–µ—Ä—Ä–∏ –º–µ–¥–æ–≤—ã–µ", "unit": "–∫–≥" },
                    { "id": "tom_che_s", "name": "–¢–æ–º–∞—Ç —á–µ—Ä—Ä–∏ –º–∏–Ω–∏ —Å–ª–∏–≤–∫–∞", "unit": "–∫–≥" },
                    { "id": "tom_che_v", "name": "–¢–æ–º–∞—Ç —á–µ—Ä—Ä–∏ –Ω–∞ –≤–µ—Ç–∫–µ", "unit": "–∫–≥" },
                    { "id": "tom_che_mix", "name": "–¢–æ–º–∞—Ç—ã –ß–µ—Ä—Ä–∏ –ú–∏–∫—Å", "unit": "–∫–≥" },
                    { "id": "tom_kum", "name": "–¢–æ–º–∞—Ç –∫—É–º–∞—Ç–æ", "unit": "–∫–≥" },
                    { "id": "tom_ban", "name": "–¢–æ–º–∞—Ç –ë–∞–Ω—á", "unit": "–∫–≥" }
                ]},
                "cucumbers": { "name": "–û–≥—É—Ä—Ü—ã", "items": [
                    { "id": "cuc_bak", "name": "–û–≥—É—Ä—Ü—ã –±–∞–∫–∏–Ω—Å–∫–∏–µ", "unit": "–∫–≥" },
                    { "id": "cuc_lng", "name": "–û–≥—É—Ä–µ—Ü –¥–ª–∏–Ω–Ω–æ–ø–ª–æ–¥–Ω—ã–π", "unit": "–∫–≥" },
                    { "id": "cuc_kur", "name": "–û–≥—É—Ä—Ü—ã –ö—É—Ä–∞–∂", "unit": "–∫–≥" },
                    { "id": "cuc_lux", "name": "–û–≥—É—Ä—Ü—ã –õ—é–∫—Å/–ú–∏—Ä–∏–Ω–¥–∞", "unit": "–∫–≥" }
                ]},
                "potatoes": { "name": "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å", "items": [
                    { "id": "pot_bat", "name": "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å –ë–∞—Ç–∞—Ç", "unit": "–∫–≥" },
                    { "id": "pot_bab", "name": "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å –±—ç–±–∏", "unit": "–∫–≥" },
                    { "id": "pot_bab_s", "name": "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å –±—ç–±–∏ —Å–∏–Ω–µ–≥–ª–∞–∑–∫–∞", "unit": "–∫–≥" },
                    { "id": "pot_gal", "name": "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å –ì–∞–ª–∞", "unit": "–∫–≥" },
                    { "id": "pot_gri", "name": "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å –≥—Ä–∏–ª—å", "unit": "–∫–≥" },
                    { "id": "pot_red_d", "name": "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å –∫—Ä–∞—Å–Ω—ã–π (–≥—Ä—è–∑–Ω—ã–π)", "unit": "–∫–≥" },
                    { "id": "pot_red_m", "name": "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å –º—ã—Ç—ã–π –∫—Ä–∞—Å–Ω—ã–π", "unit": "–∫–≥" },
                    { "id": "pot_myt", "name": "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å –º—ã—Ç—ã–π", "unit": "–∫–≥" }
                ]},
                "cabbage": { "name": "–ö–∞–ø—É—Å—Ç–∞", "items": [
                    { "id": "cab_bk", "name": "–ö–∞–ø—É—Å—Ç–∞ –±/–∫", "unit": "–∫–≥" },
                    { "id": "cab_bro", "name": "–ö–∞–ø—É—Å—Ç–∞ –±—Ä–æ–∫–∫–æ–ª–∏", "unit": "–∫–≥" },
                    { "id": "cab_bro_cal", "name": "–ö–∞–ø—É—Å—Ç–∞ –±—Ä–æ–∫–∫–æ–ª–∏ (–∫–∞–ª–∏–±—Ä)", "unit": "–∫–≥" },
                    { "id": "cab_bru", "name": "–ö–∞–ø—É—Å—Ç–∞ –±—Ä—é—Å—Å–µ–ª—å—Å–∫–∞—è", "unit": "–∫–≥" },
                    { "id": "cab_kol", "name": "–ö–∞–ø—É—Å—Ç–∞ –∫–æ–ª—å—Ä–∞–±–∏", "unit": "–∫–≥" },
                    { "id": "cab_red", "name": "–ö–∞–ø—É—Å—Ç–∞ –∫—Ä–∞—Å–Ω–æ–∫–æ—á–∞–Ω–Ω–∞—è", "unit": "–∫–≥" },
                    { "id": "cab_mol", "name": "–ö–∞–ø—É—Å—Ç–∞ –º–æ–ª–æ–¥–∞—è", "unit": "–∫–≥" },
                    { "id": "cab_mol_s", "name": "–ö–∞–ø—É—Å—Ç–∞ –º–æ–ª–æ–¥–∞—è —Å–∞–ª–∞—Ç–Ω–∞—è", "unit": "–∫–≥" },
                    { "id": "cab_pek", "name": "–ö–∞–ø—É—Å—Ç–∞ –ü–µ–∫–∏–Ω—Å–∫–∞—è", "unit": "–∫–≥" },
                    { "id": "cab_sav", "name": "–ö–∞–ø—É—Å—Ç–∞ –°–∞–≤–æ–π—Å–∫–∞—è", "unit": "–∫–≥" },
                    { "id": "cab_col", "name": "–ö–∞–ø—É—Å—Ç–∞ —Ü–≤–µ—Ç–Ω–∞—è", "unit": "–∫–≥" },
                    { "id": "cab_col_cal", "name": "–ö–∞–ø—É—Å—Ç–∞ —Ü–≤–µ—Ç–Ω–∞—è (–∫–∞–ª–∏–±—Ä)", "unit": "–∫–≥" },
                    { "id": "kale", "name": "–ö–µ–π–ª", "unit": "–∫–≥" }
                ]},
                "onions": { "name": "–õ—É–∫ –∏ –ß–µ—Å–Ω–æ–∫", "items": [
                    { "id": "luk_wh", "name": "–õ—É–∫ –±–µ–ª—ã–π", "unit": "–∫–≥" },
                    { "id": "luk_gr_kor", "name": "–õ—É–∫ –∑–µ–ª–µ–Ω—ã–π —Å –∫–æ—Ä–µ—à–∫–∞–º–∏", "unit": "–∫–≥" },
                    { "id": "luk_gr", "name": "–õ—É–∫ –∑–µ–ª–µ–Ω—ã–π", "unit": "–∫–≥" },
                    { "id": "luk_red", "name": "–õ—É–∫ –∫—Ä–∞—Å–Ω—ã–π", "unit": "–∫–≥" },
                    { "id": "luk_yal", "name": "–õ—É–∫ –∫—Ä—ã–º—Å–∫–∏–π", "unit": "–∫–≥" },
                    { "id": "luk_por", "name": "–õ—É–∫ –ø–æ—Ä–µ–π", "unit": "–∫–≥" },
                    { "id": "luk_rep", "name": "–õ—É–∫ —Ä–µ–ø—á–∞—Ç—ã–π", "unit": "–∫–≥" },
                    { "id": "luk_rep_big", "name": "–õ—É–∫ —Ä–µ–ø—á–∞—Ç—ã–π –∫—Ä—É–ø–Ω—ã–π", "unit": "–∫–≥" },
                    { "id": "luk_sib", "name": "–õ—É–∫ —Å–∏–±—É–ª–µ—Ç", "unit": "–∫–≥" },
                    { "id": "luk_sha", "name": "–õ—É–∫ —à–∞–ª–æ—Ç", "unit": "–∫–≥" },
                    { "id": "ches", "name": "–ß–µ—Å–Ω–æ–∫", "unit": "–∫–≥" },
                    { "id": "ches_mol", "name": "–ß–µ—Å–Ω–æ–∫ –º–æ–ª–æ–¥–æ–π", "unit": "–∫–≥" }
                ]},
                "peppers": { "name": "–ü–µ—Ä—Ü—ã", "items": [
                    { "id": "pep_yel", "name": "–ü–µ—Ä–µ—Ü –±–æ–ª–≥–∞—Ä—Å–∫–∏–π –∂–µ–ª—Ç—ã–π", "unit": "–∫–≥" },
                    { "id": "pep_grn", "name": "–ü–µ—Ä–µ—Ü –±–æ–ª–≥–∞—Ä—Å–∫–∏–π –∑–µ–ª–µ–Ω—ã–π", "unit": "–∫–≥" },
                    { "id": "pep_red", "name": "–ü–µ—Ä–µ—Ü –±–æ–ª–≥–∞—Ä—Å–∫–∏–π –∫—Ä–∞—Å–Ω—ã–π", "unit": "–∫–≥" },
                    { "id": "pep_gr_red", "name": "–ü–µ—Ä–µ—Ü –≥—Ä—É–Ω—Ç –∫—Ä–∞—Å–Ω—ã–π", "unit": "–∫–≥" },
                    { "id": "pep_ram", "name": "–ü–µ—Ä–µ—Ü –†–∞–º–∏—Ä–æ", "unit": "–∫–≥" },
                    { "id": "chil_gr_arm", "name": "–ü–µ—Ä–µ—Ü –ß–∏–ª–∏ –∑–µ–ª–µ–Ω—ã–π (–ê—Ä–º)", "unit": "–∫–≥" },
                    { "id": "chil_gr", "name": "–ü–µ—Ä–µ—Ü –ß–∏–ª–∏ –∑–µ–ª–µ–Ω—ã–π", "unit": "–∫–≥" },
                    { "id": "chil_rd", "name": "–ü–µ—Ä–µ—Ü –ß–∏–ª–∏ –∫—Ä–∞—Å–Ω—ã–π", "unit": "–∫–≥" },
                    { "id": "chil_thai", "name": "–ü–µ—Ä–µ—Ü –ß–∏–ª–∏ –¢–∞–π—Å–∫–∏–π (80–≥)", "unit": "—É–ø" }
                ]},
                "other": { "name": "–î—Ä—É–≥–∏–µ –æ–≤–æ—â–∏", "items": [
                    { "id": "art_gr", "name": "–ê—Ä—Ç–∏—à–æ–∫–∏ –∑–µ–ª–µ–Ω—ã–µ", "unit": "–∫–≥" },
                    { "id": "art_vi", "name": "–ê—Ä—Ç–∏—à–æ–∫–∏ —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–µ", "unit": "–∫–≥" },
                    { "id": "bakl", "name": "–ë–∞–∫–ª–∞–∂–∞–Ω", "unit": "–∫–≥" },
                    { "id": "bakl_gr", "name": "–ë–∞–∫–ª–∞–∂–∞–Ω –≥—Ä—É–Ω—Ç–æ–≤–æ–π", "unit": "–∫–≥" },
                    { "id": "goroh", "name": "–ì–æ—Ä–æ—Ö —Å—Ç—Ä—É—á–∫–æ–≤—ã–π (–ö–µ–Ω–∏—è)", "unit": "–∫–≥" },
                    { "id": "kab_wh", "name": "–ö–∞–±–∞—á–æ–∫ –±–µ–ª—ã–π", "unit": "–∫–≥" },
                    { "id": "kuk", "name": "–ö—É–∫—É—Ä—É–∑–∞ —Å–≤–µ–∂–∞—è", "unit": "–∫–≥" },
                    { "id": "seld_st", "name": "–°—Ç–µ–±–µ–ª—å —Å–µ–ª—å–¥–µ—Ä–µ—è", "unit": "–∫–≥" },
                    { "id": "spar", "name": "–°–ø–∞—Ä–∂–∞ –∑–µ–ª–µ–Ω–∞—è", "unit": "–∫–≥" },
                    { "id": "tyk_bat", "name": "–¢—ã–∫–≤–∞ –ë–∞—Ç—Ç–µ—Ä–Ω–∞—Ç", "unit": "–∫–≥" },
                    { "id": "tyk_rou", "name": "–¢—ã–∫–≤–∞ –∫—Ä—É–≥–ª–∞—è", "unit": "–∫–≥" },
                    { "id": "fasol", "name": "–§–∞—Å–æ–ª—å —Å—Ç—Ä—É—á–∫–æ–≤–∞—è (–ö–µ–Ω–∏—è)", "unit": "–∫–≥" },
                    { "id": "fenhel", "name": "–§–µ–Ω—Ö–µ–ª—å", "unit": "–∫–≥" },
                    { "id": "zuk", "name": "–¶—É–∫–∫–∏–Ω–∏ –∑–µ–ª–µ–Ω—ã–µ", "unit": "–∫–≥" }
                ]}
            }
        },
        "grn": {
            "name": "–ó–µ–ª–µ–Ω—å", "icon": "üåø",
            "subs": {
                "spicy": { "name": "–ü—Ä—è–Ω—ã–µ —Ç—Ä–∞–≤—ã", "items": [
                    { "id": "baz_pot", "name": "–ë–∞–∑–∏–ª–∏–∫ –≤ –≥–æ—Ä—à–æ—á–∫–µ", "unit": "—à—Ç" },
                    { "id": "baz_gr_iz", "name": "–ë–∞–∑–∏–ª–∏–∫ –∑–µ–ª–µ–Ω—ã–π (–ò–∑—Ä–∞–∏–ª—å)", "unit": "–∫–≥" },
                    { "id": "baz_rd", "name": "–ë–∞–∑–∏–ª–∏–∫ –∫—Ä–∞—Å–Ω—ã–π", "unit": "–∫–≥" },
                    { "id": "kerv", "name": "–ö–µ—Ä–≤–µ–ª—å", "unit": "–∫–≥" },
                    { "id": "kinza", "name": "–ö–∏–Ω–∑–∞", "unit": "–∫–≥" },
                    { "id": "myata", "name": "–ú—è—Ç–∞ —Å–≤–µ–∂–∞—è", "unit": "–∫–≥" },
                    { "id": "petr", "name": "–ü–µ—Ç—Ä—É—à–∫–∞", "unit": "–∫–≥" },
                    { "id": "petr_kud", "name": "–ü–µ—Ç—Ä—É—à–∫–∞ –∫—É–¥—Ä—è–≤–∞—è", "unit": "–∫–≥" },
                    { "id": "rozm", "name": "–†–æ–∑–º–∞—Ä–∏–Ω", "unit": "–∫–≥" },
                    { "id": "tim", "name": "–¢–∏–º—å—è–Ω", "unit": "–∫–≥" },
                    { "id": "ukr", "name": "–£–∫—Ä–æ–ø", "unit": "–∫–≥" },
                    { "id": "shal", "name": "–®–∞–ª—Ñ–µ–π", "unit": "–∫–≥" },
                    { "id": "estr", "name": "–≠—Å—Ç—Ä–∞–≥–æ–Ω", "unit": "–∫–≥" }
                ]},
                "lettuce": { "name": "–°–∞–ª–∞—Ç—ã", "items": [
                    { "id": "mang_gr", "name": "–ú–∞–Ω–≥–æ–ª—å–¥ –∑–µ–ª–µ–Ω—ã–π (125–≥)", "unit": "—É–ø" },
                    { "id": "mang_rd", "name": "–ú–∞–Ω–≥–æ–ª—å–¥ —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π (125–≥)", "unit": "—É–ø" },
                    { "id": "mix_sal", "name": "–ú–∏–∫—Å —Å–∞–ª–∞—Ç", "unit": "–∫–≥" },
                    { "id": "min_spin", "name": "–ú–∏–Ω–∏ —à–ø–∏–Ω–∞—Ç (125–≥)", "unit": "—É–ø" },
                    { "id": "rost_soi", "name": "–†–æ—Å—Ç–∫–∏ —Å–æ–∏", "unit": "–∫–≥" },
                    { "id": "sal_ice", "name": "–°–∞–ª–∞—Ç –ê–π—Å–±–µ—Ä–≥", "unit": "–∫–≥" },
                    { "id": "sal_corn", "name": "–°–∞–ª–∞—Ç –∫–æ—Ä–Ω (125–≥—Ä)", "unit": "—É–ø" },
                    { "id": "sal_lat", "name": "–°–∞–ª–∞—Ç –ª–∞—Ç—É–∫", "unit": "–∫–≥" },
                    { "id": "sal_lol", "name": "–°–∞–ª–∞—Ç –õ–æ–ª–ª–æ –†–æ—Å—Å–æ", "unit": "–∫–≥" },
                    { "id": "sal_pak", "name": "–°–∞–ª–∞—Ç –ü–∞–∫ –ß–æ–π", "unit": "–∫–≥" },
                    { "id": "sal_pak_min", "name": "–°–∞–ª–∞—Ç –ü–∞–∫ –ß–æ–π –º–∏–Ω–∏", "unit": "–∫–≥" },
                    { "id": "sal_rad", "name": "–°–∞–ª–∞—Ç –†–∞–¥–∏—á–∏–æ", "unit": "–∫–≥" },
                    { "id": "sal_rom", "name": "–°–∞–ª–∞—Ç –†–æ–º–∞–Ω–æ", "unit": "–∫–≥" },
                    { "id": "sal_rom_min", "name": "–°–∞–ª–∞—Ç –†–æ–º–∞–Ω–æ –º–∏–Ω–∏", "unit": "–∫–≥" },
                    { "id": "sal_ruk", "name": "–°–∞–ª–∞—Ç –†—É–∫–∫–æ–ª–∞ –≤–µ—Å", "unit": "–∫–≥" },
                    { "id": "sal_ruk_lux", "name": "–°–∞–ª–∞—Ç –†—É–∫–∫–æ–ª–∞ –õ—é–∫—Å (125–≥)", "unit": "—É–ø" },
                    { "id": "sal_fri", "name": "–°–∞–ª–∞—Ç –§—Ä–∏–∑–µ", "unit": "–∫–≥" },
                    { "id": "sal_fril", "name": "–°–∞–ª–∞—Ç –§—Ä–∏–ª–ª–∏—Å", "unit": "–∫–≥" },
                    { "id": "sal_mos", "name": "–°–∞–ª–∞—Ç –º–æ—Å–∫–æ–≤—Å–∫–∏–π", "unit": "–∫–≥" },
                    { "id": "sats", "name": "–°–∞—Ü–∏–º–∞—Ç–∏", "unit": "–∫–≥" },
                    { "id": "spin", "name": "–®–ø–∏–Ω–∞—Ç", "unit": "–∫–≥" },
                    { "id": "shav", "name": "–©–∞–≤–µ–ª—å", "unit": "–∫–≥" }
                ]},
                "micro": { "name": "–ú–∏–∫—Ä–æ–∑–µ–ª–µ–Ω—å", "items": [
                    { "id": "mic_an", "name": "–ú–∏–∫—Ä–æ–∑–µ–ª–µ–Ω—å –ê–Ω—é—Ç–∏–Ω—ã –≥–ª–∞–∑–∫–∏", "unit": "—É–ø" },
                    { "id": "mic_baz", "name": "–ú–∏–∫—Ä–æ–∑–µ–ª–µ–Ω—å –ë–∞–∑–∏–ª–∏–∫ –∑–µ–ª–µ–Ω—ã–π", "unit": "—É–ø" },
                    { "id": "mic_vas", "name": "–ú–∏–∫—Ä–æ–∑–µ–ª–µ–Ω—å –í–∞—Å–∏–ª–µ–∫", "unit": "—É–ø" },
                    { "id": "mic_gor", "name": "–ú–∏–∫—Ä–æ–∑–µ–ª–µ–Ω—å –≥–æ—Ä–æ—Ö", "unit": "—É–ø" },
                    { "id": "mic_kis", "name": "–ú–∏–∫—Ä–æ–∑–µ–ª–µ–Ω—å –ö–∏—Å–ª–∏—Ü–∞", "unit": "—É–ø" },
                    { "id": "mic_kor", "name": "–ú–∏–∫—Ä–æ–∑–µ–ª–µ–Ω—å –ö–æ—Ä–∏–∞–Ω–¥—Ä", "unit": "—É–ø" },
                    { "id": "mic_mel", "name": "–ú–∏–∫—Ä–æ–∑–µ–ª–µ–Ω—å –ú–µ–ª–∏—Å—Å–∞", "unit": "—É–ø" },
                    { "id": "mic_shav", "name": "–ú–∏–∫—Ä–æ–∑–µ–ª–µ–Ω—å —â–∞–≤–µ–ª—å", "unit": "—É–ø" }
                ]},
                "exotic_grn": { "name": "–≠–∫–∑–æ—Ç–∏–∫–∞", "items": [
                    { "id": "lemon", "name": "–õ–µ–º–æ–Ω–≥—Ä–∞—Å—Å", "unit": "–∫–≥" },
                    { "id": "list_bam", "name": "–õ–∏—Å—Ç –±–∞–º–±—É–∫–∞", "unit": "–∫–≥" },
                    { "id": "list_ban", "name": "–õ–∏—Å—Ç –±–∞–Ω–∞–Ω–∞", "unit": "–∫–≥" },
                    { "id": "list_lime", "name": "–õ–∏—Å—Ç –ª–∞–π–º–∞ (100–≥)", "unit": "—É–ø" },
                    { "id": "list_svek", "name": "–õ–∏—Å—Ç —Å–≤–µ–∫–ª—ã", "unit": "–∫–≥" },
                    { "id": "list_seld", "name": "–õ–∏—Å—Ç—å—è —Å–µ–ª—å–¥–µ—Ä–µ—è", "unit": "–∫–≥" }
                ]}
            }
        },
        "fru": {
            "name": "–§—Ä—É–∫—Ç—ã", "icon": "üçé",
            "subs": {
                "citrus": { "name": "–¶–∏—Ç—Ä—É—Å–æ–≤—ã–µ", "items": [
                    { "id": "apel", "name": "–ê–ø–µ–ª—å—Å–∏–Ω", "unit": "–∫–≥" },
                    { "id": "apel_soc", "name": "–ê–ø–µ–ª—å—Å–∏–Ω –¥–ª—è —Å–æ–∫–∞", "unit": "–∫–≥" },
                    { "id": "apel_red", "name": "–ê–ø–µ–ª—å—Å–∏–Ω –∫—Ä–∞—Å–Ω—ã–π", "unit": "–∫–≥" },
                    { "id": "grape", "name": "–ì—Ä–µ–π–ø—Ñ—Ä—É—Ç", "unit": "–∫–≥" },
                    { "id": "kum", "name": "–ö—É–º–∫–≤–∞—Ç", "unit": "–∫–≥" },
                    { "id": "lime", "name": "–õ–∞–π–º", "unit": "–∫–≥" },
                    { "id": "limon", "name": "–õ–∏–º–æ–Ω", "unit": "–∫–≥" },
                    { "id": "lim_uzb", "name": "–õ–∏–º–æ–Ω –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω", "unit": "–∫–≥" },
                    { "id": "mand_abh", "name": "–ú–∞–Ω–¥–∞—Ä–∏–Ω –ê–±—Ö–∞–∑–∏—è", "unit": "–∫–≥" },
                    { "id": "mand", "name": "–ú–∞–Ω–¥–∞—Ä–∏–Ω", "unit": "–∫–≥" },
                    { "id": "mand_vet", "name": "–ú–∞–Ω–¥–∞—Ä–∏–Ω—ã –Ω–∞ –≤–µ—Ç–æ—á–∫–µ", "unit": "–∫–≥" },
                    { "id": "pomelo", "name": "–ü–æ–º–µ–ª–æ", "unit": "–∫–≥" }
                ]},
                "exotic": { "name": "–≠–∫–∑–æ—Ç–∏–∫–∞", "items": [
                    { "id": "avo", "name": "–ê–≤–æ–∫–∞–¥–æ", "unit": "–∫–≥" },
                    { "id": "avo_has", "name": "–ê–≤–æ–∫–∞–¥–æ –•–∞—Å—Å", "unit": "–∫–≥" },
                    { "id": "avo_rou", "name": "–ê–≤–æ–∫–∞–¥–æ –∫—Ä—É–≥–ª—ã–π", "unit": "–∫–≥" },
                    { "id": "anan", "name": "–ê–Ω–∞–Ω–∞—Å –ì–æ–ª–¥", "unit": "–∫–≥" },
                    { "id": "anan_prem", "name": "–ê–Ω–∞–Ω–∞—Å –ø—Ä–µ–º–∏—É–º", "unit": "–∫–≥" },
                    { "id": "banan", "name": "–ë–∞–Ω–∞–Ω", "unit": "–∫–≥" },
                    { "id": "kiwi", "name": "–ö–∏–≤–∏", "unit": "–∫–≥" },
                    { "id": "kiwi_gold", "name": "–ö–∏–≤–∏ –ì–æ–ª–¥", "unit": "–∫–≥" },
                    { "id": "mango_per", "name": "–ú–∞–Ω–≥–æ –ø—Ä–µ–º–∏—É–º –ü–µ—Ä—É", "unit": "–∫–≥" },
                    { "id": "mango_eg", "name": "–ú–∞–Ω–≥–æ –ï–≥–∏–ø–µ—Ç", "unit": "–∫–≥" },
                    { "id": "mara", "name": "–ú–∞—Ä–∞–∫—É–π—è", "unit": "–∫–≥" },
                    { "id": "papa", "name": "–ü–∞–ø–∞–π—è", "unit": "–∫–≥" },
                    { "id": "pita_red", "name": "–ü–∏—Ç–∞—Ö–∞–π—è –∫—Ä–∞—Å–Ω–∞—è", "unit": "–∫–≥" },
                    { "id": "pita_wh", "name": "–ü–∏—Ç–∞—Ö–∞–π—è –±–µ–ª–∞—è", "unit": "–∫–≥" },
                    { "id": "fei", "name": "–§–µ–π—Ö–æ–∞", "unit": "–∫–≥" },
                    { "id": "hurma", "name": "–•—É—Ä–º–∞", "unit": "–∫–≥" },
                    { "id": "hurma_isp", "name": "–•—É—Ä–º–∞ –ò—Å–ø–∞–Ω–∏—è", "unit": "–∫–≥" }
                ]},
                "classic": { "name": "–ö–ª–∞—Å—Å–∏–∫–∞", "items": [
                    { "id": "aiva", "name": "–ê–π–≤–∞", "unit": "–∫–≥" },
                    { "id": "vin_wh", "name": "–í–∏–Ω–æ–≥—Ä–∞–¥ –±–µ–ª—ã–π –±/–∫", "unit": "–∫–≥" },
                    { "id": "vin_rd", "name": "–í–∏–Ω–æ–≥—Ä–∞–¥ –∫—Ä–∞—Å–Ω—ã–π –±/–∫", "unit": "–∫–≥" },
                    { "id": "vin_gr_ch", "name": "–í–∏–Ω–æ–≥—Ä–∞–¥ –ó–µ–ª–µ–Ω—ã–π (–ö–∏—Ç–∞–π)", "unit": "–∫–≥" },
                    { "id": "gran", "name": "–ì—Ä–∞–Ω–∞—Ç", "unit": "–∫–≥" },
                    { "id": "gran_soc", "name": "–ì—Ä–∞–Ω–∞—Ç —Å–æ–∫–æ–≤—ã–π", "unit": "–∫–≥" },
                    { "id": "gru_con", "name": "–ì—Ä—É—à–∞ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è", "unit": "–∫–≥" },
                    { "id": "gru_for", "name": "–ì—Ä—É—à–∞ –§–æ—Ä–µ–ª—å", "unit": "–∫–≥" },
                    { "id": "gru_chi", "name": "–ì—Ä—É—à–∞ –∫–∏—Ç–∞–π—Å–∫–∞—è", "unit": "–∫–≥" },
                    { "id": "sliva", "name": "–°–ª–∏–≤–∞ —á–µ—Ä–Ω–∞—è", "unit": "–∫–≥" },
                    { "id": "yab_gol", "name": "–Ø–±–ª–æ–∫–∏ –ì–æ–ª–¥–µ–Ω", "unit": "–∫–≥" },
                    { "id": "yab_gre", "name": "–Ø–±–ª–æ–∫–∏ –ì—Ä–µ–Ω–Ω–∏ –°–º–∏—Ç", "unit": "–∫–≥" },
                    { "id": "yab_red", "name": "–Ø–±–ª–æ–∫–∏ –∫—Ä–∞—Å–Ω—ã–µ –ê–π–¥–∞—Ä–µ–¥", "unit": "–∫–≥" },
                    { "id": "yab_sem", "name": "–Ø–±–ª–æ–∫–∏ –°–µ–º–µ—Ä–µ–Ω–∫–æ", "unit": "–∫–≥" }
                ]}
            }
        },
        "ber": {
            "name": "–Ø–≥–æ–¥—ã", "icon": "üçì",
            "subs": {
                "all": { "name": "–í—Å–µ —è–≥–æ–¥—ã", "items": [
                    { "id": "golub", "name": "–ì–æ–ª—É–±–∏–∫–∞", "unit": "–∫–≥" },
                    { "id": "eje", "name": "–ï–∂–µ–≤–∏–∫–∞", "unit": "–∫–≥" },
                    { "id": "klub", "name": "–ö–ª—É–±–Ω–∏–∫–∞", "unit": "–∫–≥" },
                    { "id": "malina", "name": "–ú–∞–ª–∏–Ω–∞", "unit": "–∫–≥" },
                    { "id": "smor", "name": "–°–º–æ—Ä–æ–¥–∏–Ω–∞ –∫—Ä–∞—Å–Ω–∞—è", "unit": "–∫–≥" },
                    { "id": "fiz", "name": "–§–∏–∑–∞–ª–∏—Å", "unit": "—à—Ç" }
                ]}
            }
        },
        "mus": {
            "name": "–ì—Ä–∏–±—ã", "icon": "üçÑ",
            "subs": {
                "all": { "name": "–í—Å–µ –≥—Ä–∏–±—ã", "items": [
                    { "id": "vesh", "name": "–í–µ—à–µ–Ω–∫–∏", "unit": "–∫–≥" },
                    { "id": "shamp", "name": "–®–∞–º–ø–∏–Ω—å–æ–Ω—ã", "unit": "–∫–≥" },
                    { "id": "shiit", "name": "–ì—Ä–∏–±—ã –®–∏–∏—Ç–∞–∫–∏", "unit": "–∫–≥" },
                    { "id": "shim", "name": "–ì—Ä–∏–±—ã –®–∏–º–∏–¥–∂–∏ (150–≥)", "unit": "—à—Ç" }
                ]}
            }
        }
    };

    let cart = {}, comments = {};
    let allItems = [], fuse, curItem = null;

    function init() {
        // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        Object.keys(DB).forEach(k => {
            const cat = DB[k];
            if(cat.subs) {
                Object.values(cat.subs).forEach(s => {
                    s.items.forEach(i => allItems.push({...i, cat:k}));
                });
            }
        });
        fuse = new Fuse(allItems, { keys:['name'], threshold:0.3 });
        
        renderAccordion();
        setupSearch();
    }

    // === ACCORDION RENDER ===
    function renderAccordion() {
        const c = document.getElementById('accordionView');
        c.innerHTML = '';
        
        Object.keys(DB).forEach(catKey => {
            const cat = DB[catKey];
            
            // Main Category
            const catDiv = document.createElement('div');
            catDiv.innerHTML = `
                <div class="cat-row" onclick="toggleCat('${catKey}', this)">
                    <div><span class="cat-icon">${cat.icon}</span>${cat.name}</div>
                    <span class="arrow">‚ñº</span>
                </div>
                <div id="cat-${catKey}" class="sub-container"></div>
            `;
            c.appendChild(catDiv);

            // Subcategories
            const subCont = catDiv.querySelector(`#cat-${catKey}`);
            if(cat.subs) {
                Object.keys(cat.subs).forEach(subKey => {
                    const sub = cat.subs[subKey];
                    const isSingle = Object.keys(cat.subs).length === 1 && subKey === 'all';
                    
                    const subDiv = document.createElement('div');
                    // –ï—Å–ª–∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è –≤—Å–µ–≥–æ –æ–¥–Ω–∞ "–≤—Å–µ", –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–µ –Ω—É–∂–µ–Ω
                    const headerHTML = isSingle ? '' : `<div class="sub-header">${sub.name}</div>`;
                    
                    subDiv.innerHTML = `
                        ${headerHTML}
                        <div class="item-list" id="list-${catKey}-${subKey}"></div>
                    `;
                    subCont.appendChild(subDiv);
                    
                    // Render Items directly to avoid massive recalculations on open
                    const listEl = subDiv.querySelector(`#list-${catKey}-${subKey}`);
                    sub.items.forEach(item => {
                        listEl.appendChild(createItemRow(item));
                    });
                });
            }
        });
    }

    function toggleCat(key, header) {
        const content = document.getElementById(`cat-${key}`);
        const isHidden = !content.classList.contains('visible');
        
        // Close others? No, allow multiple open for comparison
        content.classList.toggle('visible');
        header.classList.toggle('expanded');
    }

    function createItemRow(i) {
        const div = document.createElement('div');
        div.className = 'item-row';
        div.id = `row-${i.id}`;
        div.innerHTML = renderItemContent(i);
        return div;
    }

    function renderItemContent(i) {
        const q = cart[i.id] || 0;
        const hasCom = comments[i.id];
        
        const btnHtml = q > 0 
            ? `<div class="counter-wrap" onclick="openInput('${i.id}')">
                 <span class="counter-val">${q}</span>
                 <span class="counter-unit">${i.unit}</span>
               </div>`
            : `<button class="btn-add" onclick="addItem('${i.id}')">–î–æ–±–∞–≤–∏—Ç—å</button>`;
            
        const comHtml = q > 0 
            ? `<button class="btn-comment ${hasCom?'active':''}" onclick="openComment('${i.id}')">üí¨</button>` 
            : '';

        return `
            <div class="item-info">
                <div class="item-name">${i.name}</div>
                <div class="item-unit">–∑–∞ ${i.unit}</div>
            </div>
            <div style="display:flex; align-items:center;">
                ${comHtml}
                ${btnHtml}
            </div>
        `;
    }

    // === ACTIONS ===
    window.addItem = (id) => { cart[id] = 1; refreshItem(id); }
    
    function refreshItem(id) {
        const item = allItems.find(x => x.id == id);
        
        // Update in Accordion
        const row = document.getElementById(`row-${id}`);
        if(row) row.innerHTML = renderItemContent(item);
        
        // Update in Search if visible
        const searchRow = document.getElementById(`search-row-${id}`);
        if(searchRow) searchRow.innerHTML = renderItemContent(item);
        
        updateCartBadge();
    }

    window.openInput = (id) => {
        curItem = id;
        const i = allItems.find(x => x.id == id);
        document.getElementById('inputName').innerText = i.name;
        document.getElementById('inputUnit').innerText = i.unit;
        document.getElementById('sysInput').value = cart[id];
        openModal('inputModal');
        setTimeout(() => document.getElementById('sysInput').focus(), 100);
    }

    window.saveInput = () => {
        const val = parseFloat(document.getElementById('sysInput').value);
        if(val > 0) cart[curItem] = val;
        else { delete cart[curItem]; delete comments[curItem]; }
        refreshItem(curItem);
        closeModal('inputModal');
    }

    window.openComment = (id) => {
        curItem = id;
        document.getElementById('comName').innerText = allItems.find(x => x.id == id).name;
        document.getElementById('comText').value = comments[id] || '';
        openModal('commentModal');
    }

    window.saveComment = () => {
        const val = document.getElementById('comText').value.trim();
        if(val) comments[curItem] = val; else delete comments[curItem];
        refreshItem(curItem);
        closeModal('commentModal');
    }

    function updateCartBadge() {
        const cnt = Object.keys(cart).length;
        const btn = document.getElementById('cartBtn');
        const badge = document.getElementById('cartBadge');
        
        if(cnt > 0) {
            btn.classList.remove('hidden');
            badge.innerText = cnt;
        } else {
            btn.classList.add('hidden');
        }
    }

    // === SEARCH ===
    function setupSearch() {
        const inp = document.getElementById('search');
        const resDiv = document.getElementById('searchResults');
        const accDiv = document.getElementById('accordionView');
        
        inp.addEventListener('input', (e) => {
            const val = e.target.value.trim();
            
            if(val.length < 2) {
                resDiv.classList.remove('visible');
                accDiv.classList.remove('hidden');
                return;
            }
            
            accDiv.classList.add('hidden');
            resDiv.classList.add('visible');
            
            const results = fuse.search(val);
            resDiv.innerHTML = '';
            
            if(results.length === 0) {
                resDiv.innerHTML = '<div style="text-align:center; color:#8e8e93; padding:20px;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                return;
            }
            
            results.forEach(r => {
                const div = document.createElement('div');
                div.className = 'item-row';
                div.id = `search-row-${r.item.id}`;
                div.innerHTML = renderItemContent(r.item);
                resDiv.appendChild(div);
            });
        });
    }

    // === ORDER ===
    window.openOrderModal = () => {
        const list = document.getElementById('orderList');
        list.innerHTML = '';
        
        allItems.forEach(i => {
            if(cart[i.id]) {
                const com = comments[i.id] ? `<div style="font-size:13px; color:#8e8e93; font-style:italic;">üí¨ ${comments[i.id]}</div>` : '';
                const row = document.createElement('div');
                row.className = 'order-row';
                row.innerHTML = `
                    <div style="flex:1;">
                        <div class="order-name">${i.name}</div>
                        ${com}
                    </div>
                    <div class="order-qty">${cart[i.id]} ${i.unit}</div>
                `;
                list.appendChild(row);
            }
        });
        openModal('orderModal');
    }

    window.sendOrder = () => {
        const data = {
            cart: cart,
            comments: comments,
            global_comment: document.getElementById('globalCom').value
        };
        tg.sendData(JSON.stringify(data));
    }

    // UTILS
    window.openModal = (id) => document.getElementById(id).classList.add('visible');
    window.closeModal = (id) => document.getElementById(id).classList.remove('visible');

    init();
</script>
</body>
</html>
