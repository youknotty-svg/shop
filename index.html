<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fresh Market</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <style>
        :root {
            --bg: #000000;
            --card-bg: rgba(28, 28, 30, 0.6);
            --item-bg: rgba(44, 44, 46, 0.6);
            --text: #ffffff;
            --text-sec: #8e8e93;
            --accent: #0a84ff;
            --danger: #ff453a;
            --glass: blur(20px) saturate(180%);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            padding-bottom: 100px;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        /* GLASS HEADER */
        .header {
            position: sticky; top: 0; z-index: 1000;
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: var(--glass);
            -webkit-backdrop-filter: var(--glass);
            border-bottom: 0.5px solid rgba(255,255,255,0.1);
            padding: 16px;
            transition: all 0.3s ease;
        }

        .search-wrap { 
            position: relative; width: 100%; 
            transform: translateZ(0);
        }
        .search-input {
            width: 100%; padding: 14px 44px 14px 44px;
            border-radius: 18px; border: none;
            background: rgba(118, 118, 128, 0.24);
            color: #fff; font-size: 17px;
            transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .search-input:focus {
            background: rgba(118, 118, 128, 0.4);
            transform: scale(1.01);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); opacity: 0.6; font-size: 18px; }

        /* ANIMATIONS */
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes tap { 0% { transform: scale(1); } 50% { transform: scale(0.96); } 100% { transform: scale(1); } }

        /* ACCORDION (iOS style lists) */
        .container { padding: 16px; display: flex; flex-direction: column; gap: 16px; }

        /* Main Category Card */
        .cat-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 22px;
            overflow: hidden;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 0.5px solid rgba(255,255,255,0.08);
        }
        .cat-header {
            padding: 20px;
            display: flex; align-items: center; justify-content: space-between;
            font-size: 20px; font-weight: 700; letter-spacing: 0.3px;
            cursor: pointer;
            background: rgba(255,255,255,0.03);
        }
        .cat-header:active { background: rgba(255,255,255,0.08); }
        .cat-icon { font-size: 28px; margin-right: 14px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        .arrow { 
            font-size: 14px; color: rgba(235, 235, 245, 0.3); font-weight: 600; 
            transition: transform 0.4s cubic-bezier(0.25, 0.1, 0.25, 1.3);
            background: rgba(255,255,255,0.1); width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center; border-radius: 50%;
        }
        .cat-header.expanded .arrow { transform: rotate(180deg); background: var(--accent); color: #fff; }

        /* Subcategories */
        .sub-container { display: none; padding-bottom: 8px; }
        .sub-container.visible { display: block; animation: slideIn 0.3s ease-out; }

        .sub-group { margin: 0 12px 12px; border-radius: 16px; overflow: hidden; background: rgba(0,0,0,0.2); }

        .sub-header {
            padding: 16px;
            font-size: 17px; font-weight: 600; color: rgba(255,255,255,0.9);
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; border-bottom: 0.5px solid rgba(255,255,255,0.05);
        }
        .sub-header:active { background: rgba(255,255,255,0.05); }
        .sub-arrow { color: var(--text-sec); font-size: 12px; transition: transform 0.3s; }
        .sub-header.expanded .sub-arrow { transform: rotate(180deg); color: var(--accent); }

        /* Item Rows */
        .item-list { display: none; }
        .item-list.visible { display: block; }

        .item-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px;
            border-bottom: 0.5px solid rgba(255,255,255,0.05);
            background: rgba(30, 30, 32, 0.4);
            transition: background 0.2s;
        }
        .item-row:last-child { border-bottom: none; }
        .item-info { flex: 1; padding-right: 14px; }
        .item-name { 
            font-size: 17px; font-weight: 500; color: #fff; line-height: 1.3;
            letter-spacing: -0.2px;
        }

        /* CONTROLS (BIGGER & BETTER) */
        .btn-add {
            background: var(--accent);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 600; font-size: 15px;
            box-shadow: 0 4px 12px rgba(10, 132, 255, 0.3);
            transition: transform 0.1s;
            cursor: pointer;
        }
        .btn-add:active { transform: scale(0.94); box-shadow: 0 2px 6px rgba(10, 132, 255, 0.2); }

        .counter-pill {
            display: flex; align-items: center; gap: 2px;
            background: rgba(60, 60, 65, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 4px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }
        .counter-pill:active { transform: scale(0.96); }

        .btn-mini {
            width: 36px; height: 36px;
            border-radius: 50%; border: none;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; font-weight: 600;
            cursor: pointer; transition: background 0.2s;
        }
        .btn-minus { background: transparent; color: #ff453a; }
        .btn-minus:active { background: rgba(255, 69, 58, 0.2); }
        .btn-plus { background: #fff; color: #000; }
        .btn-plus:active { background: #e5e5e5; }

        .val-display {
            min-width: 44px; text-align: center;
            font-size: 16px; font-weight: 700; color: #fff;
            font-variant-numeric: tabular-nums;
        }

        .btn-comment {
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(255,255,255,0.08); border: none;
            color: #fff; font-size: 18px; margin-right: 10px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .btn-comment.active { background: var(--accent); box-shadow: 0 0 10px rgba(10,132,255,0.5); }
        .btn-comment:active { transform: scale(0.9); }

        /* FLOATING CART (Glassmorphism) */
        .cart-bar {
            position: fixed; bottom: 24px; left: 16px; right: 16px;
            height: 64px;
            background: rgba(30, 30, 30, 0.85);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border-radius: 32px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 8px 0 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 900;
            transform: translateY(120%); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .cart-bar.visible { transform: translateY(0); }

        .cart-info { display: flex; flex-direction: column; }
        .cart-count { font-size: 18px; font-weight: 700; color: #fff; }
        .cart-sub { font-size: 12px; color: rgba(255,255,255,0.5); font-weight: 500; }

        .btn-checkout {
            background: #fff; color: #000;
            border: none; padding: 0 24px; height: 48px;
            border-radius: 24px;
            font-weight: 700; font-size: 16px;
            box-shadow: 0 4px 15px rgba(255,255,255,0.2);
            transition: transform 0.2s;
        }
        .btn-checkout:active { transform: scale(0.94); }

        /* MODALS (iOS Sheet) */
        .modal {
            position: fixed; inset: 0; z-index: 2000;
            background: rgba(0,0,0,0.01); 
            display: none; align-items: flex-end;
            transition: background 0.3s;
        }
        .modal.visible { background: rgba(0,0,0,0.6); display: flex; backdrop-filter: blur(4px); }

        .modal-card {
            background: #1c1c1e; width: 100%;
            border-radius: 28px 28px 0 0; padding: 24px 20px 40px;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.15, 0.9, 0.3, 1.1);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .modal.visible .modal-card { transform: translateY(0); }

        .modal-drag { width: 40px; height: 5px; background: rgba(255,255,255,0.2); border-radius: 3px; margin: 0 auto 20px; }

        .sys-input {
            width: 100%; background: transparent; border: none;
            color: #fff; font-size: 48px; font-weight: 800;
            text-align: center; margin: 20px 0; outline: none;
            text-shadow: 0 0 20px rgba(255,255,255,0.2);
        }

        .modal-btns { display: flex; gap: 12px; }
        .btn-modal {
            flex: 1; padding: 16px; border-radius: 18px; border: none;
            font-size: 17px; font-weight: 600; cursor: pointer;
            transition: transform 0.1s;
        }
        .btn-modal:active { transform: scale(0.97); }
        .btn-sec { background: rgba(255,255,255,0.1); color: #fff; }
        .btn-prim { background: #fff; color: #000; box-shadow: 0 4px 15px rgba(255,255,255,0.15); }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="header">
        <div class="search-wrap">
            <span class="search-icon">üîç</span>
            <input type="text" class="search-input" id="search" placeholder="–ü–æ–∏—Å–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –∞–≤–æ–∫–∞–¥–æ)">
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <div id="searchResults" class="search-results hidden" style="display:flex; flex-direction:column; gap:8px;"></div>
        <div id="accordionView"></div>
    </div>

    <!-- Glass Cart Bar -->
    <div class="cart-bar" id="cartBar">
        <div class="cart-info">
            <span class="cart-count" id="cartCount">0 —Ç–æ–≤–∞—Ä–æ–≤</span>
            <span class="cart-sub">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–∫–∞–∑–∞</span>
        </div>
        <button class="btn-checkout" onclick="openOrderModal()">–û—Ñ–æ—Ä–º–∏—Ç—å ‚ûî</button>
    </div>

    <!-- Input Modal -->
    <div class="modal" id="inputModal" onclick="if(event.target===this) closeModal('inputModal')">
        <div class="modal-card">
            <div class="modal-drag"></div>
            <div id="inputName" style="text-align: center; color: var(--text-sec); font-size:16px; font-weight:500;"></div>
            <input type="number" id="sysInput" class="sys-input" inputmode="decimal" placeholder="0">
            <div style="text-align:center; color:#555; margin-bottom:20px; font-size:14px;">–í–≤–µ–¥–∏—Ç–µ —Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
            <div class="modal-btns">
                <button class="btn-modal btn-sec" onclick="closeModal('inputModal')">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn-modal btn-prim" onclick="saveInput()">–ì–æ—Ç–æ–≤–æ</button>
            </div>
        </div>
    </div>

    <!-- Comment Modal -->
    <div class="modal" id="commentModal" onclick="if(event.target===this) closeModal('commentModal')">
        <div class="modal-card">
            <div class="modal-drag"></div>
            <h3 style="text-align:center; margin-bottom:16px;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h3>
            <textarea id="comText" style="width:100%; height:120px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#fff; border-radius:16px; padding:16px; font-size:17px; resize:none;" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è..."></textarea>
            <div class="modal-btns" style="margin-top:20px;">
                <button class="btn-modal btn-sec" onclick="closeModal('commentModal')">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn-modal btn-prim" onclick="saveComment()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Order Modal -->
    <div class="modal" id="orderModal" onclick="if(event.target===this) closeModal('orderModal')">
        <div class="modal-card" style="max-height:90vh;">
            <div class="modal-drag"></div>
            <h2 style="font-size:28px; font-weight:800; margin-bottom:20px;">–í–∞—à –∑–∞–∫–∞–∑</h2>
            <div id="orderList" style="margin-bottom: 24px; max-height:40vh; overflow-y:auto; padding-right:4px;"></div>
            <textarea id="globalCom" style="width:100%; height:80px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#fff; border-radius:16px; padding:16px; font-size:16px; margin-bottom:20px;" placeholder="–û–±—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É..."></textarea>
            <button class="btn-modal btn-prim" style="width:100%; padding:18px;" onclick="sendOrder()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</button>
        </div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.setHeaderColor('#141414');
    tg.setBackgroundColor('#000000');

    // DATA
    const DB = {
        "veg": { "name": "–û–≤–æ—â–∏", "icon": "ü•¶", "subs": {
            "roots": { "name": "–ö–æ—Ä–Ω–µ–ø–ª–æ–¥—ã", "items": [
                { "id": "galan", "name": "–ì–∞–ª–∞–Ω–≥–∞–ª –∫–æ—Ä–µ–Ω—å", "u": "–∫–≥" },
                { "id": "daik", "name": "–î–∞–π–∫–æ–Ω", "u": "–∫–≥" },
                { "id": "imbir", "name": "–ò–º–±–∏—Ä—å –∫–æ—Ä–µ–Ω—å", "u": "–∫–≥" },
                { "id": "mor_yel", "name": "–ú–æ—Ä–∫–æ–≤—å –∂–µ–ª—Ç–∞—è", "u": "–∫–≥" },
                { "id": "mor_myt", "name": "–ú–æ—Ä–∫–æ–≤—å –º—ã—Ç–∞—è", "u": "–∫–≥" },
                { "id": "mor_ros", "name": "–ú–æ—Ä–∫–æ–≤—å –†–æ—Å—Å–∏—è", "u": "–∫–≥" },
                { "id": "mor_bot", "name": "–ú–æ—Ä–∫–æ–≤—å —Å –±–æ—Ç–≤–æ–π", "u": "–∫–≥" },
                { "id": "past", "name": "–ü–∞—Å—Ç–µ—Ä–Ω–∞–∫", "u": "–∫–≥" },
                { "id": "rad_red", "name": "–†–µ–¥–∏—Å –∫—Ä–∞—Å–Ω—ã–π", "u": "–∫–≥" },
                { "id": "red_arb", "name": "–†–µ–¥—å–∫–∞ –∞—Ä–±—É–∑–Ω–∞—è", "u": "–∫–≥" },
                { "id": "rad_bot", "name": "–†–µ–¥–∏—Å —Å –±–æ—Ç–≤–æ–π", "u": "–∫–≥" },
                { "id": "repa", "name": "–†–µ–ø–∞", "u": "–∫–≥" },
                { "id": "svek", "name": "–°–≤–µ–∫–ª–∞", "u": "–∫–≥" },
                { "id": "seld_kor", "name": "–ö–æ—Ä–µ–Ω—å —Å–µ–ª—å–¥–µ—Ä–µ—è", "u": "–∫–≥" },
                { "id": "topin", "name": "–¢–æ–ø–∏–Ω–∞–º–±—É—Ä", "u": "–∫–≥" },
                { "id": "hren", "name": "–•—Ä–µ–Ω –∫–æ—Ä–µ–Ω—å", "u": "–∫–≥" }
            ]},
            "tomatoes": { "name": "–¢–æ–º–∞—Ç—ã", "items": [
                { "id": "tom_kra", "name": "–¢–æ–º–∞—Ç –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä", "u": "–∫–≥" },
                { "id": "tom_yel", "name": "–¢–æ–º–∞—Ç –∂–µ–ª—Ç—ã–π", "u": "–∫–≥" },
                { "id": "tom_slv", "name": "–¢–æ–º–∞—Ç –∫—Ä–∞—Å–Ω—ã–π —Å–ª–∏–≤–∫–∞", "u": "–∫–≥" },
                { "id": "tom_gri", "name": "–¢–æ–º–∞—Ç –ì—Ä–∏–ª—å", "u": "–∫–≥" },
                { "id": "tom_uzb_l", "name": "–¢–æ–º–∞—Ç –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω (–õ—é–∫—Å)", "u": "–∫–≥" },
                { "id": "tom_uzb", "name": "–¢–æ–º–∞—Ç –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω", "u": "–∫–≥" },
                { "id": "tom_aze", "name": "–¢–æ–º–∞—Ç –ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω", "u": "–∫–≥" },
                { "id": "tom_dag", "name": "–¢–æ–º–∞—Ç –î–∞–≥–µ—Å—Ç–∞–Ω", "u": "–∫–≥" },
                { "id": "tom_che_y", "name": "–ß–µ—Ä—Ä–∏ –∂–µ–ª—Ç—ã–µ", "u": "–∫–≥" },
                { "id": "tom_che_r", "name": "–ß–µ—Ä—Ä–∏ –∫—Ä–∞—Å–Ω—ã–µ", "u": "–∫–≥" },
                { "id": "tom_che_k", "name": "–ß–µ—Ä—Ä–∏ –∫—É–º–∞—Ç–æ", "u": "–∫–≥" },
                { "id": "tom_che_m", "name": "–ß–µ—Ä—Ä–∏ –º–µ–¥–æ–≤—ã–µ", "u": "–∫–≥" },
                { "id": "tom_che_s", "name": "–ß–µ—Ä—Ä–∏ –º–∏–Ω–∏ —Å–ª–∏–≤–∫–∞", "u": "–∫–≥" },
                { "id": "tom_che_v", "name": "–ß–µ—Ä—Ä–∏ –Ω–∞ –≤–µ—Ç–∫–µ", "u": "–∫–≥" },
                { "id": "tom_che_mix", "name": "–ß–µ—Ä—Ä–∏ –ú–∏–∫—Å", "u": "–∫–≥" },
                { "id": "tom_kum", "name": "–¢–æ–º–∞—Ç –∫—É–º–∞—Ç–æ", "u": "–∫–≥" },
                { "id": "tom_ban", "name": "–¢–æ–º–∞—Ç –ë–∞–Ω—á", "u": "–∫–≥" }
            ]},
            "cucumbers": { "name": "–û–≥—É—Ä—Ü—ã", "items": [
                { "id": "cuc_bak", "name": "–û–≥—É—Ä—Ü—ã –±–∞–∫–∏–Ω—Å–∫–∏–µ", "u": "–∫–≥" },
                { "id": "cuc_lng", "name": "–û–≥—É—Ä–µ—Ü –¥–ª–∏–Ω–Ω–æ–ø–ª–æ–¥–Ω—ã–π", "u": "–∫–≥" },
                { "id": "cuc_kur", "name": "–û–≥—É—Ä—Ü—ã –ö—É—Ä–∞–∂", "u": "–∫–≥" },
                { "id": "cuc_lux", "name": "–û–≥—É—Ä—Ü—ã –õ—é–∫—Å/–ú–∏—Ä–∏–Ω–¥–∞", "u": "–∫–≥" }
            ]},
            "potatoes": { "name": "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å", "items": [
                { "id": "pot_bat", "name": "–ë–∞—Ç–∞—Ç", "u": "–∫–≥" },
                { "id": "pot_bab", "name": "–ë—ç–±–∏", "u": "–∫–≥" },
                { "id": "pot_bab_s", "name": "–ë—ç–±–∏ —Å–∏–Ω–µ–≥–ª–∞–∑–∫–∞", "u": "–∫–≥" },
                { "id": "pot_gal", "name": "–ì–∞–ª–∞", "u": "–∫–≥" },
                { "id": "pot_gri", "name": "–ì—Ä–∏–ª—å", "u": "–∫–≥" },
                { "id": "pot_red_d", "name": "–ö—Ä–∞—Å–Ω—ã–π (–≥—Ä—è–∑–Ω—ã–π)", "u": "–∫–≥" },
                { "id": "pot_red_m", "name": "–ö—Ä–∞—Å–Ω—ã–π (–º—ã—Ç—ã–π)", "u": "–∫–≥" },
                { "id": "pot_myt", "name": "–ú—ã—Ç—ã–π", "u": "–∫–≥" }
            ]},
            "cabbage": { "name": "–ö–∞–ø—É—Å—Ç–∞", "items": [
                { "id": "cab_bk", "name": "–ö–∞–ø—É—Å—Ç–∞ –±/–∫", "u": "–∫–≥" },
                { "id": "cab_bro", "name": "–ë—Ä–æ–∫–∫–æ–ª–∏", "u": "–∫–≥" },
                { "id": "cab_bro_cal", "name": "–ë—Ä–æ–∫–∫–æ–ª–∏ (–∫–∞–ª–∏–±—Ä)", "u": "–∫–≥" },
                { "id": "cab_bru", "name": "–ë—Ä—é—Å—Å–µ–ª—å—Å–∫–∞—è", "u": "–∫–≥" },
                { "id": "cab_kol", "name": "–ö–æ–ª—å—Ä–∞–±–∏", "u": "–∫–≥" },
                { "id": "cab_red", "name": "–ö—Ä–∞—Å–Ω–æ–∫–æ—á–∞–Ω–Ω–∞—è", "u": "–∫–≥" },
                { "id": "cab_mol", "name": "–ú–æ–ª–æ–¥–∞—è", "u": "–∫–≥" },
                { "id": "cab_mol_s", "name": "–ú–æ–ª–æ–¥–∞—è —Å–∞–ª–∞—Ç–Ω–∞—è", "u": "–∫–≥" },
                { "id": "cab_pek", "name": "–ü–µ–∫–∏–Ω—Å–∫–∞—è", "u": "–∫–≥" },
                { "id": "cab_sav", "name": "–°–∞–≤–æ–π—Å–∫–∞—è", "u": "–∫–≥" },
                { "id": "cab_col", "name": "–¶–≤–µ—Ç–Ω–∞—è", "u": "–∫–≥" },
                { "id": "cab_col_cal", "name": "–¶–≤–µ—Ç–Ω–∞—è (–∫–∞–ª–∏–±—Ä)", "u": "–∫–≥" },
                { "id": "kale", "name": "–ö–µ–π–ª", "u": "–∫–≥" }
            ]},
            "onions": { "name": "–õ—É–∫ –∏ –ß–µ—Å–Ω–æ–∫", "items": [
                { "id": "luk_wh", "name": "–õ—É–∫ –±–µ–ª—ã–π", "u": "–∫–≥" },
                { "id": "luk_gr_kor", "name": "–õ—É–∫ –∑–µ–ª–µ–Ω—ã–π (—Å –∫–æ—Ä–Ω–µ–º)", "u": "–∫–≥" },
                { "id": "luk_gr", "name": "–õ—É–∫ –∑–µ–ª–µ–Ω—ã–π", "u": "–∫–≥" },
                { "id": "luk_red", "name": "–õ—É–∫ –∫—Ä–∞—Å–Ω—ã–π", "u": "–∫–≥" },
                { "id": "luk_yal", "name": "–õ—É–∫ –∫—Ä—ã–º—Å–∫–∏–π", "u": "–∫–≥" },
                { "id": "luk_por", "name": "–õ—É–∫ –ø–æ—Ä–µ–π", "u": "–∫–≥" },
                { "id": "luk_rep", "name": "–õ—É–∫ —Ä–µ–ø—á–∞—Ç—ã–π", "u": "–∫–≥" },
                { "id": "luk_rep_big", "name": "–õ—É–∫ —Ä–µ–ø—á–∞—Ç—ã–π –∫—Ä—É–ø–Ω—ã–π", "u": "–∫–≥" },
                { "id": "luk_sib", "name": "–õ—É–∫ —Å–∏–±—É–ª–µ—Ç", "u": "–∫–≥" },
                { "id": "luk_sha", "name": "–õ—É–∫ —à–∞–ª–æ—Ç", "u": "–∫–≥" },
                { "id": "ches", "name": "–ß–µ—Å–Ω–æ–∫", "u": "–∫–≥" },
                { "id": "ches_mol", "name": "–ß–µ—Å–Ω–æ–∫ –º–æ–ª–æ–¥–æ–π", "u": "–∫–≥" }
            ]},
            "peppers": { "name": "–ü–µ—Ä—Ü—ã", "items": [
                { "id": "pep_yel", "name": "–ü–µ—Ä–µ—Ü –±–æ–ª–≥–∞—Ä—Å–∫–∏–π –∂–µ–ª—Ç—ã–π", "u": "–∫–≥" },
                { "id": "pep_grn", "name": "–ü–µ—Ä–µ—Ü –±–æ–ª–≥–∞—Ä—Å–∫–∏–π –∑–µ–ª–µ–Ω—ã–π", "u": "–∫–≥" },
                { "id": "pep_red", "name": "–ü–µ—Ä–µ—Ü –±–æ–ª–≥–∞—Ä—Å–∫–∏–π –∫—Ä–∞—Å–Ω—ã–π", "u": "–∫–≥" },
                { "id": "pep_gr_red", "name": "–ü–µ—Ä–µ—Ü –≥—Ä—É–Ω—Ç –∫—Ä–∞—Å–Ω—ã–π", "u": "–∫–≥" },
                { "id": "pep_ram", "name": "–ü–µ—Ä–µ—Ü –†–∞–º–∏—Ä–æ", "u": "–∫–≥" },
                { "id": "chil_gr_arm", "name": "–ß–∏–ª–∏ –∑–µ–ª–µ–Ω—ã–π (–ê—Ä–º)", "u": "–∫–≥" },
                { "id": "chil_gr", "name": "–ß–∏–ª–∏ –∑–µ–ª–µ–Ω—ã–π", "u": "–∫–≥" },
                { "id": "chil_rd", "name": "–ß–∏–ª–∏ –∫—Ä–∞—Å–Ω—ã–π", "u": "–∫–≥" },
                { "id": "chil_thai", "name": "–ß–∏–ª–∏ –¢–∞–π—Å–∫–∏–π (80–≥)", "u": "—É–ø" }
            ]},
            "other": { "name": "–î—Ä—É–≥–∏–µ –æ–≤–æ—â–∏", "items": [
                { "id": "art_gr", "name": "–ê—Ä—Ç–∏—à–æ–∫–∏ –∑–µ–ª–µ–Ω—ã–µ", "u": "–∫–≥" },
                { "id": "art_vi", "name": "–ê—Ä—Ç–∏—à–æ–∫–∏ —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–µ", "u": "–∫–≥" },
                { "id": "bakl", "name": "–ë–∞–∫–ª–∞–∂–∞–Ω", "u": "–∫–≥" },
                { "id": "bakl_gr", "name": "–ë–∞–∫–ª–∞–∂–∞–Ω –≥—Ä—É–Ω—Ç–æ–≤–æ–π", "u": "–∫–≥" },
                { "id": "goroh", "name": "–ì–æ—Ä–æ—Ö —Å—Ç—Ä—É—á–∫–æ–≤—ã–π (–ö–µ–Ω–∏—è)", "u": "–∫–≥" },
                { "id": "kab_wh", "name": "–ö–∞–±–∞—á–æ–∫ –±–µ–ª—ã–π", "u": "–∫–≥" },
                { "id": "kuk", "name": "–ö—É–∫—É—Ä—É–∑–∞ —Å–≤–µ–∂–∞—è", "u": "–∫–≥" },
                { "id": "seld_st", "name": "–°—Ç–µ–±–µ–ª—å —Å–µ–ª—å–¥–µ—Ä–µ—è", "u": "–∫–≥" },
                { "id": "spar", "name": "–°–ø–∞—Ä–∂–∞ –∑–µ–ª–µ–Ω–∞—è", "u": "–∫–≥" },
                { "id": "tyk_bat", "name": "–¢—ã–∫–≤–∞ –ë–∞—Ç—Ç–µ—Ä–Ω–∞—Ç", "u": "–∫–≥" },
                { "id": "tyk_rou", "name": "–¢—ã–∫–≤–∞ –∫—Ä—É–≥–ª–∞—è", "u": "–∫–≥" },
                { "id": "fasol", "name": "–§–∞—Å–æ–ª—å —Å—Ç—Ä—É—á–∫–æ–≤–∞—è", "u": "–∫–≥" },
                { "id": "fenhel", "name": "–§–µ–Ω—Ö–µ–ª—å", "u": "–∫–≥" },
                { "id": "zuk", "name": "–¶—É–∫–∫–∏–Ω–∏ –∑–µ–ª–µ–Ω—ã–µ", "u": "–∫–≥" }
            ]}
        }},
        "grn": { "name": "–ó–µ–ª–µ–Ω—å", "icon": "üåø", "subs": {
            "spicy": { "name": "–ü—Ä—è–Ω—ã–µ —Ç—Ä–∞–≤—ã", "items": [
                { "id": "baz_pot", "name": "–ë–∞–∑–∏–ª–∏–∫ –≤ –≥–æ—Ä—à–æ—á–∫–µ", "u": "—à—Ç" },
                { "id": "baz_gr_iz", "name": "–ë–∞–∑–∏–ª–∏–∫ –∑–µ–ª–µ–Ω—ã–π", "u": "–∫–≥" },
                { "id": "baz_rd", "name": "–ë–∞–∑–∏–ª–∏–∫ –∫—Ä–∞—Å–Ω—ã–π", "u": "–∫–≥" },
                { "id": "kerv", "name": "–ö–µ—Ä–≤–µ–ª—å", "u": "–∫–≥" },
                { "id": "kinza", "name": "–ö–∏–Ω–∑–∞", "u": "–∫–≥" },
                { "id": "myata", "name": "–ú—è—Ç–∞ —Å–≤–µ–∂–∞—è", "u": "–∫–≥" },
                { "id": "petr", "name": "–ü–µ—Ç—Ä—É—à–∫–∞", "u": "–∫–≥" },
                { "id": "petr_kud", "name": "–ü–µ—Ç—Ä—É—à–∫–∞ –∫—É–¥—Ä—è–≤–∞—è", "u": "–∫–≥" },
                { "id": "rozm", "name": "–†–æ–∑–º–∞—Ä–∏–Ω", "u": "–∫–≥" },
                { "id": "tim", "name": "–¢–∏–º—å—è–Ω", "u": "–∫–≥" },
                { "id": "ukr", "name": "–£–∫—Ä–æ–ø", "u": "–∫–≥" },
                { "id": "shal", "name": "–®–∞–ª—Ñ–µ–π", "u": "–∫–≥" },
                { "id": "estr", "name": "–≠—Å—Ç—Ä–∞–≥–æ–Ω", "u": "–∫–≥" }
            ]},
            "lettuce": { "name": "–°–∞–ª–∞—Ç—ã", "items": [
                { "id": "mang_gr", "name": "–ú–∞–Ω–≥–æ–ª—å–¥ –∑–µ–ª–µ–Ω—ã–π (125–≥)", "u": "—É–ø" },
                { "id": "mang_rd", "name": "–ú–∞–Ω–≥–æ–ª—å–¥ —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π", "u": "—É–ø" },
                { "id": "mix_sal", "name": "–ú–∏–∫—Å —Å–∞–ª–∞—Ç", "u": "–∫–≥" },
                { "id": "min_spin", "name": "–ú–∏–Ω–∏ —à–ø–∏–Ω–∞—Ç (125–≥)", "u": "—É–ø" },
                { "id": "rost_soi", "name": "–†–æ—Å—Ç–∫–∏ —Å–æ–∏", "u": "–∫–≥" },
                { "id": "sal_ice", "name": "–°–∞–ª–∞—Ç –ê–π—Å–±–µ—Ä–≥", "u": "–∫–≥" },
                { "id": "sal_corn", "name": "–°–∞–ª–∞—Ç –∫–æ—Ä–Ω (125–≥)", "u": "—É–ø" },
                { "id": "sal_lat", "name": "–°–∞–ª–∞—Ç –ª–∞—Ç—É–∫", "u": "–∫–≥" },
                { "id": "sal_lol", "name": "–°–∞–ª–∞—Ç –õ–æ–ª–ª–æ –†–æ—Å—Å–æ", "u": "–∫–≥" },
                { "id": "sal_pak", "name": "–°–∞–ª–∞—Ç –ü–∞–∫ –ß–æ–π", "u": "–∫–≥" },
                { "id": "sal_pak_min", "name": "–°–∞–ª–∞—Ç –ü–∞–∫ –ß–æ–π –º–∏–Ω–∏", "u": "–∫–≥" },
                { "id": "sal_rad", "name": "–°–∞–ª–∞—Ç –†–∞–¥–∏—á–∏–æ", "u": "–∫–≥" },
                { "id": "sal_rom", "name": "–°–∞–ª–∞—Ç –†–æ–º–∞–Ω–æ", "u": "–∫–≥" },
                { "id": "sal_rom_min", "name": "–°–∞–ª–∞—Ç –†–æ–º–∞–Ω–æ –º–∏–Ω–∏", "u": "–∫–≥" },
                { "id": "sal_ruk", "name": "–†—É–∫–∫–æ–ª–∞ –≤–µ—Å", "u": "–∫–≥" },
                { "id": "sal_ruk_lux", "name": "–†—É–∫–∫–æ–ª–∞ –õ—é–∫—Å (125–≥)", "u": "—É–ø" },
                { "id": "sal_fri", "name": "–°–∞–ª–∞—Ç –§—Ä–∏–∑–µ", "u": "–∫–≥" },
                { "id": "sal_fril", "name": "–°–∞–ª–∞—Ç –§—Ä–∏–ª–ª–∏—Å", "u": "–∫–≥" },
                { "id": "sal_mos", "name": "–°–∞–ª–∞—Ç –º–æ—Å–∫–æ–≤—Å–∫–∏–π", "u": "–∫–≥" },
                { "id": "sats", "name": "–°–∞—Ü–∏–º–∞—Ç–∏", "u": "–∫–≥" },
                { "id": "spin", "name": "–®–ø–∏–Ω–∞—Ç", "u": "–∫–≥" },
                { "id": "shav", "name": "–©–∞–≤–µ–ª—å", "u": "–∫–≥" }
            ]},
            "micro": { "name": "–ú–∏–∫—Ä–æ–∑–µ–ª–µ–Ω—å (—É–ø)", "items": [
                { "id": "mic_an", "name": "–ê–Ω—é—Ç–∏–Ω—ã –≥–ª–∞–∑–∫–∏", "u": "—É–ø" },
                { "id": "mic_baz", "name": "–ë–∞–∑–∏–ª–∏–∫ –∑–µ–ª–µ–Ω—ã–π", "u": "—É–ø" },
                { "id": "mic_vas", "name": "–í–∞—Å–∏–ª–µ–∫", "u": "—É–ø" },
                { "id": "mic_gor", "name": "–ì–æ—Ä–æ—Ö", "u": "—É–ø" },
                { "id": "mic_kis", "name": "–ö–∏—Å–ª–∏—Ü–∞", "u": "—É–ø" },
                { "id": "mic_kor", "name": "–ö–æ—Ä–∏–∞–Ω–¥—Ä", "u": "—É–ø" },
                { "id": "mic_mel", "name": "–ú–µ–ª–∏—Å—Å–∞", "u": "—É–ø" },
                { "id": "mic_shav", "name": "–©–∞–≤–µ–ª—å", "u": "—É–ø" }
            ]},
            "exotic_grn": { "name": "–≠–∫–∑–æ—Ç–∏–∫–∞", "items": [
                { "id": "lemon", "name": "–õ–µ–º–æ–Ω–≥—Ä–∞—Å—Å", "u": "–∫–≥" },
                { "id": "list_bam", "name": "–õ–∏—Å—Ç –±–∞–º–±—É–∫–∞", "u": "–∫–≥" },
                { "id": "list_ban", "name": "–õ–∏—Å—Ç –±–∞–Ω–∞–Ω–∞", "u": "–∫–≥" },
                { "id": "list_lime", "name": "–õ–∏—Å—Ç –ª–∞–π–º–∞ (100–≥)", "u": "—É–ø" },
                { "id": "list_svek", "name": "–õ–∏—Å—Ç —Å–≤–µ–∫–ª—ã", "u": "–∫–≥" },
                { "id": "list_seld", "name": "–õ–∏—Å—Ç—å—è —Å–µ–ª—å–¥–µ—Ä–µ—è", "u": "–∫–≥" }
            ]}
        }},
        "fru": { "name": "–§—Ä—É–∫—Ç—ã", "icon": "üçé", "subs": {
            "citrus": { "name": "–¶–∏—Ç—Ä—É—Å–æ–≤—ã–µ", "items": [
                { "id": "apel", "name": "–ê–ø–µ–ª—å—Å–∏–Ω", "u": "–∫–≥" },
                { "id": "apel_soc", "name": "–ê–ø–µ–ª—å—Å–∏–Ω –¥–ª—è —Å–æ–∫–∞", "u": "–∫–≥" },
                { "id": "apel_red", "name": "–ê–ø–µ–ª—å—Å–∏–Ω –∫—Ä–∞—Å–Ω—ã–π", "u": "–∫–≥" },
                { "id": "grape", "name": "–ì—Ä–µ–π–ø—Ñ—Ä—É—Ç", "u": "–∫–≥" },
                { "id": "kum", "name": "–ö—É–º–∫–≤–∞—Ç", "u": "–∫–≥" },
                { "id": "lime", "name": "–õ–∞–π–º", "u": "–∫–≥" },
                { "id": "limon", "name": "–õ–∏–º–æ–Ω", "u": "–∫–≥" },
                { "id": "lim_uzb", "name": "–õ–∏–º–æ–Ω –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω", "u": "–∫–≥" },
                { "id": "mand_abh", "name": "–ú–∞–Ω–¥–∞—Ä–∏–Ω –ê–±—Ö–∞–∑–∏—è", "u": "–∫–≥" },
                { "id": "mand", "name": "–ú–∞–Ω–¥–∞—Ä–∏–Ω", "u": "–∫–≥" },
                { "id": "mand_vet", "name": "–ú–∞–Ω–¥–∞—Ä–∏–Ω—ã –Ω–∞ –≤–µ—Ç–æ—á–∫–µ", "u": "–∫–≥" },
                { "id": "pomelo", "name": "–ü–æ–º–µ–ª–æ", "u": "–∫–≥" }
            ]},
            "exotic": { "name": "–≠–∫–∑–æ—Ç–∏–∫–∞", "items": [
                { "id": "avo", "name": "–ê–≤–æ–∫–∞–¥–æ", "u": "–∫–≥" },
                { "id": "avo_has", "name": "–ê–≤–æ–∫–∞–¥–æ –•–∞—Å—Å", "u": "–∫–≥" },
                { "id": "avo_rou", "name": "–ê–≤–æ–∫–∞–¥–æ –∫—Ä—É–≥–ª—ã–π", "u": "–∫–≥" },
                { "id": "anan", "name": "–ê–Ω–∞–Ω–∞—Å –ì–æ–ª–¥", "u": "–∫–≥" },
                { "id": "anan_prem", "name": "–ê–Ω–∞–Ω–∞—Å –ø—Ä–µ–º–∏—É–º", "u": "–∫–≥" },
                { "id": "banan", "name": "–ë–∞–Ω–∞–Ω", "u": "–∫–≥" },
                { "id": "kiwi", "name": "–ö–∏–≤–∏", "u": "–∫–≥" },
                { "id": "kiwi_gold", "name": "–ö–∏–≤–∏ –ì–æ–ª–¥", "u": "–∫–≥" },
                { "id": "mango_per", "name": "–ú–∞–Ω–≥–æ –ø—Ä–µ–º–∏—É–º –ü–µ—Ä—É", "u": "–∫–≥" },
                { "id": "mango_eg", "name": "–ú–∞–Ω–≥–æ –ï–≥–∏–ø–µ—Ç", "u": "–∫–≥" },
                { "id": "mara", "name": "–ú–∞—Ä–∞–∫—É–π—è", "u": "–∫–≥" },
                { "id": "papa", "name": "–ü–∞–ø–∞–π—è", "u": "–∫–≥" },
                { "id": "pita_red", "name": "–ü–∏—Ç–∞—Ö–∞–π—è –∫—Ä–∞—Å–Ω–∞—è", "u": "–∫–≥" },
                { "id": "pita_wh", "name": "–ü–∏—Ç–∞—Ö–∞–π—è –±–µ–ª–∞—è", "u": "–∫–≥" },
                { "id": "fei", "name": "–§–µ–π—Ö–æ–∞", "u": "–∫–≥" },
                { "id": "hurma", "name": "–•—É—Ä–º–∞", "u": "–∫–≥" },
                { "id": "hurma_isp", "name": "–•—É—Ä–º–∞ –ò—Å–ø–∞–Ω–∏—è", "u": "–∫–≥" }
            ]},
            "classic": { "name": "–ö–ª–∞—Å—Å–∏–∫–∞", "items": [
                { "id": "aiva", "name": "–ê–π–≤–∞", "u": "–∫–≥" },
                { "id": "vin_wh", "name": "–í–∏–Ω–æ–≥—Ä–∞–¥ –±–µ–ª—ã–π –±/–∫", "u": "–∫–≥" },
                { "id": "vin_rd", "name": "–í–∏–Ω–æ–≥—Ä–∞–¥ –∫—Ä–∞—Å–Ω—ã–π –±/–∫", "u": "–∫–≥" },
                { "id": "vin_gr_ch", "name": "–í–∏–Ω–æ–≥—Ä–∞–¥ –ó–µ–ª–µ–Ω—ã–π", "u": "–∫–≥" },
                { "id": "gran", "name": "–ì—Ä–∞–Ω–∞—Ç", "u": "–∫–≥" },
                { "id": "gran_soc", "name": "–ì—Ä–∞–Ω–∞—Ç —Å–æ–∫–æ–≤—ã–π", "u": "–∫–≥" },
                { "id": "gru_con", "name": "–ì—Ä—É—à–∞ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è", "u": "–∫–≥" },
                { "id": "gru_for", "name": "–ì—Ä—É—à–∞ –§–æ—Ä–µ–ª—å", "u": "–∫–≥" },
                { "id": "gru_chi", "name": "–ì—Ä—É—à–∞ –∫–∏—Ç–∞–π—Å–∫–∞—è", "u": "–∫–≥" },
                { "id": "sliva", "name": "–°–ª–∏–≤–∞ —á–µ—Ä–Ω–∞—è", "u": "–∫–≥" },
                { "id": "yab_gol", "name": "–Ø–±–ª–æ–∫–∏ –ì–æ–ª–¥–µ–Ω", "u": "–∫–≥" },
                { "id": "yab_gre", "name": "–Ø–±–ª–æ–∫–∏ –ì—Ä–µ–Ω–Ω–∏ –°–º–∏—Ç", "u": "–∫–≥" },
                { "id": "yab_red", "name": "–Ø–±–ª–æ–∫–∏ –ê–π–¥–∞—Ä–µ–¥", "u": "–∫–≥" },
                { "id": "yab_sem", "name": "–Ø–±–ª–æ–∫–∏ –°–µ–º–µ—Ä–µ–Ω–∫–æ", "u": "–∫–≥" }
            ]}
        }},
        "ber": { "name": "–Ø–≥–æ–¥—ã", "icon": "üçì", "subs": {
            "all": { "name": "–í—Å–µ —è–≥–æ–¥—ã", "items": [
                { "id": "golub", "name": "–ì–æ–ª—É–±–∏–∫–∞", "u": "–∫–≥" },
                { "id": "eje", "name": "–ï–∂–µ–≤–∏–∫–∞", "u": "–∫–≥" },
                { "id": "klub", "name": "–ö–ª—É–±–Ω–∏–∫–∞", "u": "–∫–≥" },
                { "id": "malina", "name": "–ú–∞–ª–∏–Ω–∞", "u": "–∫–≥" },
                { "id": "smor", "name": "–°–º–æ—Ä–æ–¥–∏–Ω–∞ –∫—Ä–∞—Å–Ω–∞—è", "u": "–∫–≥" },
                { "id": "fiz", "name": "–§–∏–∑–∞–ª–∏—Å", "u": "—à—Ç" }
            ]}
        }},
        "mus": { "name": "–ì—Ä–∏–±—ã", "icon": "üçÑ", "subs": {
            "all": { "name": "–í—Å–µ –≥—Ä–∏–±—ã", "items": [
                { "id": "vesh", "name": "–í–µ—à–µ–Ω–∫–∏", "u": "–∫–≥" },
                { "id": "shamp", "name": "–®–∞–º–ø–∏–Ω—å–æ–Ω—ã", "u": "–∫–≥" },
                { "id": "shiit", "name": "–ì—Ä–∏–±—ã –®–∏–∏—Ç–∞–∫–∏", "u": "–∫–≥" },
                { "id": "shim", "name": "–ì—Ä–∏–±—ã –®–∏–º–∏–¥–∂–∏ (150–≥)", "u": "—à—Ç" }
            ]}
        }}
    };

    let cart = {}, comments = {};
    let allItems = [], fuse, curItem = null;

    function init() {
        Object.keys(DB).forEach(k => {
            const cat = DB[k];
            if(cat.subs) Object.values(cat.subs).forEach(s => s.items.forEach(i => allItems.push({...i, cat:k})));
        });
        fuse = new Fuse(allItems, { keys:['name'], threshold:0.3 });

        renderAccordion();
        setupSearch();
    }

    function renderAccordion() {
        const c = document.getElementById('accordionView');
        c.innerHTML = '';

        Object.keys(DB).forEach(catKey => {
            const cat = DB[catKey];
            const div = document.createElement('div');
            div.className = 'cat-card';

            div.innerHTML = `
                <div class="cat-header" onclick="toggleCat(this)">
                    <div style="display:flex; align-items:center;">
                        <span class="cat-icon">${cat.icon}</span>${cat.name}
                    </div>
                    <div class="arrow">‚Üì</div>
                </div>
                <div class="sub-container"></div>
            `;
            c.appendChild(div);

            const subCont = div.querySelector('.sub-container');
            if(cat.subs) {
                Object.keys(cat.subs).forEach(subKey => {
                    const sub = cat.subs[subKey];
                    const isSingle = Object.keys(cat.subs).length === 1 && subKey === 'all';

                    const group = document.createElement('div');
                    group.className = 'sub-group';

                    if(isSingle) {
                        group.innerHTML = `<div class="item-list visible" id="list-${catKey}-${subKey}"></div>`;
                    } else {
                        group.innerHTML = `
                            <div class="sub-header" onclick="toggleSub(this)">
                                <span>${sub.name}</span>
                                <span class="sub-arrow">‚ñº</span>
                            </div>
                            <div class="item-list" id="list-${catKey}-${subKey}"></div>
                        `;
                    }
                    subCont.appendChild(group);

                    const listEl = group.querySelector(`#list-${catKey}-${subKey}`);
                    sub.items.forEach(item => listEl.appendChild(createItemRow(item)));
                });
            }
        });
    }

    function toggleCat(header) {
        header.classList.toggle('expanded');
        header.nextElementSibling.classList.toggle('visible');
    }

    function toggleSub(header) {
        header.classList.toggle('expanded');
        header.nextElementSibling.classList.toggle('visible');
    }

    function createItemRow(i) {
        const div = document.createElement('div');
        div.className = 'item-row';
        div.id = `row-${i.id}`;
        div.innerHTML = renderItemContent(i);
        return div;
    }

    function renderItemContent(i) {
        const q = cart[i.id] || 0;
        const hasCom = comments[i.id];

        let controls = '';

        if (q === 0) {
            controls = `<button class="btn-add" onclick="addItem('${i.id}')">–î–æ–±–∞–≤–∏—Ç—å</button>`;
        } else {
            controls = `
                <div class="counter-pill">
                    <button class="btn-comment ${hasCom?'active':''}" onclick="openComment('${i.id}')">üí¨</button>
                    <button class="btn-mini btn-minus" onclick="changeQty('${i.id}', -1)">‚àí</button>
                    <div class="val-display" onclick="openInput('${i.id}')">${q}</div>
                    <button class="btn-mini btn-plus" onclick="changeQty('${i.id}', 1)">+</button>
                </div>
            `;
        }

        return `
            <div class="item-info">
                <div class="item-name">${i.name}</div>
            </div>
            <div>${controls}</div>
        `;
    }

    // ACTIONS
    window.addItem = (id) => { cart[id] = 1; refreshItem(id); triggerTap(); }
    window.changeQty = (id, delta) => {
        const curr = cart[id] || 0;
        const next = curr + delta;
        if(next <= 0) { delete cart[id]; delete comments[id]; } 
        else cart[id] = next;
        refreshItem(id); triggerTap();
    }

    function refreshItem(id) {
        const item = allItems.find(x => x.id == id);
        const row = document.getElementById(`row-${id}`);
        if(row) row.innerHTML = renderItemContent(item);
        const sRow = document.getElementById(`search-row-${id}`);
        if(sRow) sRow.innerHTML = renderItemContent(item);
        updateCartBar();
    }

    function updateCartBar() {
        const count = Object.keys(cart).length;
        const bar = document.getElementById('cartBar');
        document.getElementById('cartCount').innerText = `${count} –ø–æ–∑–∏—Ü–∏–π`;

        if(count > 0) bar.classList.add('visible'); 
        else bar.classList.remove('visible');
    }

    window.openInput = (id) => {
        curItem = id;
        const i = allItems.find(x => x.id == id);
        document.getElementById('inputName').innerText = `${i.name} (${i.u})`;
        document.getElementById('sysInput').value = cart[id];
        openModal('inputModal');
        setTimeout(()=>document.getElementById('sysInput').focus(),100);
    }

    window.saveInput = () => {
        const val = parseFloat(document.getElementById('sysInput').value);
        if(val > 0) cart[curItem] = val;
        else { delete cart[curItem]; delete comments[curItem]; }
        refreshItem(curItem); closeModal('inputModal');
    }

    window.openComment = (id) => {
        curItem = id;
        document.getElementById('comText').value = comments[id] || '';
        openModal('commentModal');
        setTimeout(()=>document.getElementById('comText').focus(),100);
    }

    window.saveComment = () => {
        const val = document.getElementById('comText').value.trim();
        if(val) comments[curItem] = val; else delete comments[curItem];
        refreshItem(curItem); closeModal('commentModal');
    }

    // ORDER
    window.openOrderModal = () => {
        const list = document.getElementById('orderList');
        list.innerHTML = '';
        allItems.forEach(i => {
            if(cart[i.id]) {
                const row = document.createElement('div');
                row.style.padding = '12px 0';
                row.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                row.style.display = 'flex'; row.style.justifyContent='space-between';

                let comHtml = comments[i.id] ? `<div style="color:#0a84ff; font-size:13px; margin-top:4px;">üí¨ ${comments[i.id]}</div>` : '';

                row.innerHTML = `
                    <div>
                        <div style="font-size:16px; font-weight:600;">${i.name}</div>
                        ${comHtml}
                    </div>
                    <div style="font-size:18px; font-weight:700;">${cart[i.id]} <span style="font-size:12px; font-weight:400; color:#888;">${i.u}</span></div>
                `;
                list.appendChild(row);
            }
        });
        openModal('orderModal');
    }

    window.sendOrder = () => {
        const data = { cart, comments, global: document.getElementById('globalCom').value };
        tg.sendData(JSON.stringify(data));
    }

    // SEARCH
    function setupSearch() {
        const inp = document.getElementById('search');
        const resDiv = document.getElementById('searchResults');
        const accDiv = document.getElementById('accordionView');

        inp.addEventListener('input', (e) => {
            const val = e.target.value.trim();
            if(val.length < 2) {
                resDiv.classList.add('hidden'); accDiv.classList.remove('hidden'); return;
            }
            accDiv.classList.add('hidden'); resDiv.classList.remove('hidden');

            const res = fuse.search(val);
            resDiv.innerHTML = '';
            if(res.length===0) { resDiv.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>'; return; }

            res.forEach(r => {
                const d = document.createElement('div');
                d.className = 'cat-card'; // Reuse styling
                d.innerHTML = `<div class="item-row" id="search-row-${r.item.id}">${renderItemContent(r.item)}</div>`;
                resDiv.appendChild(d);
            });
        });
    }

    // ANIMATIONS
    function triggerTap() { document.body.style.animation = 'none'; document.body.offsetHeight; document.body.style.animation = 'tap 0.2s'; }
    window.openModal = (id) => document.getElementById(id).classList.add('visible');
    window.closeModal = (id) => document.getElementById(id).classList.remove('visible');

    init();
</script>
</body>
</html>
